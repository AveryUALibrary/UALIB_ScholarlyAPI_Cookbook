---
title: "CAS Common Chemistry API in R"
output: 
  html_document:
    keep_md: TRUE
---
by Adam Miramontes Nguyen

The recipe examples were tested on March 24, 2023.

**CAS Common Chemistry API Documentation (requires registration):**

https://www.cas.org/services/commonchemistry-api

See the bottom of the document for information on R and package versions.

**Attribution:** This tutorial uses the [CAS Common Chemistry](https://commonchemistry.cas.org/) API. Example Data shown is licensed under the [CC BY-NC 4.0 license](https://creativecommons.org/licenses/by-nc/4.0/).

## Import libraries
Run the following lines of code to load the libraries 'httr' and 'jsonlite'. If you have not done so already, additionally, before the 'library()' functions, run 'install.packages(c('httr','jsonlite'))'.
```{r library, warning=FALSE, message=FALSE}
#install.packages(c('httr','jsonlite'))
library(httr)
library(jsonlite)
```

# 1. Common Chemistry Record Detail Retrieval

Common Chemistry is an extremely useful open community resource for accessing chemical information for nearly 500,000 chemical chemistry from the CAS registry. In this example we are going to detail the steps in which a user can query and access a simple example chemical substance, ethyl cyclohexanepropionate.

## Setup API parameters   

First let's setup the API parameters for Common Chemistry. Below we are going to provide a variable 'detail_base_url' to query Common Chemistry for details and more specifically, in this example, using a registry number, or as we abbreviate it an 'rn'.
```{r api_params, warning=FALSE, message = FALSE}
detail_base_url <- "https://commonchemistry.cas.org/api/detail?"
casrn1 <- "10094-36-7" # ethyl cyclohexanepropionate
```
## Request data from CAS Common Chemistry Detail API

Using the 'httr' and 'JSONlite' libraries, we will query and convert the data into a usable format.

```{r Req, warning=FALSE, message=FALSE}
# Using httr's 'GET()' function, retrieve raw data from link
raw_casrn1_data <-GET(paste0(detail_base_url, "cas_rn=", casrn1)) #paste0 concatenates inputs with no spaces
raw_casrn1_data
```
The 'GET()' function returns Response, Date & Time, Status: 200 indicating a successful request, Size, and most importantly Content-Type. In most cases when accessing APIs, the Content-Type will return json, which is why we need JSONlite.
```{r convert}
# Access content using the library jsonlite
json_casrn1_data <- rawToChar(raw_casrn1_data$content) #returns JSON structure in character format

json_casrn1_data

# Using fromJSON() we can convert the JSON format to a list
casrn1_data <- fromJSON(json_casrn1_data)

casrn1_data

```
## Accessing specific data

To access specifc data of the list we can use the '$' operator to extract the specific part of the data object.   

For example:
```{r extract, warning=FALSE, message=FALSE}
# Accessing the SMILE
smile_casrn1_data <- casrn1_data$smile

smile_casrn1_data

# Another example may be finding synonyms for Ethyl cyclohexanepropionate

syn_casrn1_data <- casrn1_data$synonyms

syn_casrn1_data
```


The methods above work for any parts of the data object, to find a list of the data objects, you can use the 'ls()' function.
```{r ls, warning=FALSE, message=FALSE}
ls(casrn1_data)

```

Given this list we can select different data as seen in previous examples, i.e. 'casrn1_data$(example)'.


## Display the molecule drawing   


### Using SVG       

According to Wikipedia, Scalable Vector Graphics, or SVG, is an XML based vector format for defining two-dimensional graphics and has been an open standard since 1999. Using the SVG data provided by the API, we will display the molecule drawing using the package 'magick', a useful toolkit for image processing in R.
```{r Display, warning=FALSE, message=FALSE}
# Import magick library
# NOTE: Run 'install.packages('magick') if you haven't already.
library(magick)
str <- charToRaw(casrn1_data$image)
image_read(str,200)
```



# 2. Common Chemistry API record detail retrieval in a loop   

Similar to the previous example, we will show how to query Common Chemistry for details given some registry number, but in this case show how this would be achievable through a list of registry numbers. This is extremely useful for researchers and users interested in large lists of chemical substances.

```{r loop, warning=FALSE, message = FALSE}
detail_base_url <- "https://commonchemistry.cas.org/api/detail?"

# Create a list of casrn
casrn_list <- as.list(c("10094-36-7", "10031-92-2", "10199-61-8", "10036-21-2", "1019020-13-3")) 

n<-length(casrn_list) # To be used for future use



# Iterate through list of casrn and append to list
list <- lapply(casrn_list, function(i) {
  raw_casrn_data <- GET(paste0(detail_base_url, "cas_rn=", i))
  json_casrn_data <- rawToChar(raw_casrn_data$content)
  casrn_data <- fromJSON(json_casrn_data)
  Sys.sleep(1)
  return(casrn_data)
})
 

head(list,n=1) # We now have a list of sublists of data corresponding to the casrn.


```
## Display Images

```{r disp list}

# First using 'lapply', we iterate through list and apply 'function(x)' that converts our image into a readable format
imgs<-lapply(list, function(x) {(charToRaw(x$image))})
# Using 'image_read()' read SVGs

# "Ethyl cyclohexanepropionate"
image_scale(image_read(imgs[[1]]),200)
# "Ethyl 2-nonynoate"
image_scale(image_read(imgs[[2]]),200)
# "Ethyl 1<em>H</em>-pyrazole-1-acetate"
image_scale(image_read(imgs[[3]]),200)
# "Ethyl 3-(ethoxycarbonyl)benzenepropanoate"
image_scale(image_read(imgs[[4]]),200)
# "Ethyl 1-cyclohexene-1-carboximidate"
image_scale(image_read(imgs[[5]]),200)
```

## Select some specific data    

Using 'lapply()', we iterate through the list and grab each sub-list's canonicalSmile.
```{r specdat, warning=FALSE, message=FALSE}
cansmiles<-lapply(list, function(i) {i$canonicalSmile}) #Apply function(i), receiving canonicalSmiles, to every instance in the list
unlist(cansmiles) #flatten list
```
Through similar means, we can also iterate through the list and grab each sub-list's synonyms.
```{r getsyns, warning=FALSE, message =FALSE}

synonyms_list <- lapply(list, function(j){j$synonyms})
synonyms_list
```
```{r flatsyns, warning=FALSE, message =FALSE}
# Using the 'unlist()' function we flatten our list of synonyms
flatsyns <- unlist(synonyms_list)
flatsyns
```
## Create Dataframe   

Let's create a dataframe from 'list' with the variables: 'uri', 'rn', 'name', 'inchiKey', 'canonicalSmile', and 'molecularMass'.

```{r list2df, warning=FALSE, message=FALSE}

df<-setNames(data.frame # Let R know we're creating a df
             (do.call 
               (rbind,lapply(1:length(list),function(i) # Iterate through list of chemicals with function(i) and append to df
                 cbind(list[[i]][1],list[[i]][2],list[[i]][3],list[[i]][6],list[[i]][8],list[[i]][10])))), # Grab indices
             c("uri","rn", "name", "inchiKey", "canonicalSmile", "molecularMass")) # Rename grabbed

# Display df
df
```

# 3. Common Chemistry 

In addition to the /detail API, the CAS Common Chemistry API has a /search method that allows searching by CAS RN, SMILES, InChI/InChIKey, and name.

## Request data form CAS Common Chemistry Search API

```{r search, warning=FALSE, message = FALSE}
search_base_url <- "https://commonchemistry.cas.org/api/search?q="

# InChIKey for Quinine
IK <- "InChIKey=LOUPRKONTZGTKE-WZBLMQSHSA-N"
quinine_search_data <- GET(paste0(search_base_url,IK))
quinine_search_data
```

Similar to before we have received only some information on the response, so we must convert this response into some usable data.

```{r usable, warning=FALSE,  message=FALSE}
# Access content using the library jsonlite
quinine_rn_json <- rawToChar(quinine_search_data$content) #returns JSON structure in character format

# Using fromJSON() we can convert the JSON format to a list
quinine_rn <- fromJSON(quinine_rn_json)

quinine_rn

```

Now we have the quinine's registry number, so we can query quinine based on this, similar to example 1.


```{r quinine_detail, warning=FALSE, message=FALSE}
# get detailed record for quinine
detail_base_url <- "https://commonchemistry.cas.org/api/detail?"
quinine_detail_data <- GET(paste0(detail_base_url , "cas_rn=" , quinine_rn$results$rn))
quinine_detail_data

# Similar to before, we are going to convert this into usable data
# Access content using the library jsonlite
quinine_json <- rawToChar(quinine_detail_data$content) #returns JSON structure in character format

# Using fromJSON() we can convert the JSON format to a list
quinine_data <- fromJSON(quinine_json)

quinine_data

```

## Handle multiple results
```{r multiple_results, warning=FALSE, message=FALSE}
# setup search query parameters
search_base_url <- "https://commonchemistry.cas.org/api/search?q="
# SMILES for butadiene
smi_bd <- "C=CC=C"

# Request data from CAS Common Chemistry Search API
smi_search_data <- GET(paste0(search_base_url, smi_bd))

smi_search_json <- rawToChar(smi_search_data$content) #returns JSON structure in character format

# Using fromJSON() we can convert the JSON format to a list
smi_search_data <- fromJSON(smi_search_json)

# get results count

smi_search_data$count

#Display rn's

smi_search_data$results$rn

names <- lapply(smi_search_data$results$rn, function(x){
  detail_base_url <- "https://commonchemistry.cas.org/api/detail?"
  detail_base_data <- GET(paste0(detail_base_url , "cas_rn=" , x))
  # Similar to before, we are going to convert this into usable data
  # Access content using the library jsonlite
  detail_base_json <- rawToChar(detail_base_data$content) #returns JSON structure in character format

  # Create detailed data of the current chemical in the iteration
  detail_data <<- fromJSON(detail_base_json)
  
  # Access name of chemical
  
  smi_names <- detail_data$name

return(smi_names)
Sys.sleep(1)
})
unlist(names) #Display names
```


## Handle multiple page results   

The CAS Common Chemistry API returns 50 results per page, and only the first page is returned by default. If the search returns more than 50 results, the offset option can be added to page through and obtain all results:

```{r multi_page, warning=FALSE, message= FALSE}
# setup search query parameters
search_base_url <- "https://commonchemistry.cas.org/api/search?q="
n <- "selen*"
# calculate number of pages needed
num_results <- 200  # total number of results to retrieve
page_size <- 50     # number of results to retrieve per page
num_pages <- ceiling(num_results / page_size)

# create empty list for results
n_search_data <- list()

# loop through the pages of data
for (page_idx in seq_len(num_pages)) {
  # calculate the starting offset for the current page
  offset <- (page_idx - 1) * page_size
  
  # construct the search URL for the current page
  search_url <- paste0(search_base_url, n, "&offset=", offset)
  
  # make the API request and append the response to the list of results
  response <- httr::GET(search_url)
  n_search_data[[page_idx]] <- httr::content(response)
  
  # pause for 1 second to avoid overloading the server
  Sys.sleep(1)
}
# Length of search data includes a top level list for each query
length(n_search_data)
# List within lists contain the results
length(n_search_data[[1]]$results)
length(n_search_data[[2]]$results)
length(n_search_data[[3]]$results)
length(n_search_data[[4]]$results)

# We can index and extract out the first CASRN as follows

n_search_data[[1]]$results[[1]]$rn
```
```{r extractCASRN, warning=FALSE, message=FALSE}
# Extract out all CAS RNs from the list of lists

n_casrn_list <- vector()
for (n_idx in seq_along(n_search_data)) { # top level list
  for (casrn_idx in seq_along(n_search_data[[n_idx]]$results)) { # lists within top level
    n_casrn_list <- c(n_casrn_list, n_search_data[[n_idx]]$results[[casrn_idx]]$rn)
  }
}
length(n_casrn_list)
n_casrn_list[1:20]
```


We can now iterate through  the list of registry numbers to store data about the chemicals, in this example we will extract a list of 'molecularMass' values and visualize them.

```{r moleMass, warning=FALSE, message=FALSE}
# now we can loop through each casrn and use the detail API to obtain the entire record
# this will query CAS Common Chem 191 times and take ~ 5 min.
detail_base_url <- "https://commonchemistry.cas.org/api/detail?"
n_detail_data <- list()
for (casrn in n_casrn_list) {
  response <- GET(paste0(detail_base_url, "cas_rn=", casrn))
  n_detail_data[[casrn]] <- content(response)
  Sys.sleep(1) # add a delay between API calls
}

```
```{r moleMassCont., warning=FALSE, message=FALSE}
mms <- list()
for (mm_idx in seq_along(n_detail_data)) {
  mms <- c(mms, n_detail_data[[mm_idx]]$molecularMass)
}
head(mms, n=20)
```
### Visualization   

Using the list of molecular mass values we collected in the previous example from the search query of 'selen*' we can create some neat visualizations in R using the 'hist()' and 'density()' functions.
```{r hist, warning=FALSE, message=FALSE}
# Histogram
hist(as.numeric(mms), # Reformat mms type to numeric and call as x variable
     breaks = 20,
     main = "Histogram of available molecularMass values", # Set title
     xlab = "Molecular Mass", # X Label
     ylab = "Count", # Y Label
     col = "plum", ) # Color

```

We can alternatively make a  kernel density plot, a graph that uses a continuous curve to depict the distribution of the data, in this case with respect to the molecular mass values. This will give some more fidelity as opposed to the histogram.

```{r kernel, warning=FALSE, message=FALSE}
d <- density(na.omit(as.numeric(mms)))
plot(d, main="Kernel Density of Available mms values")
polygon(d, col="plum", border="black")
```

# R Session Info

```{r version, warning=FALSE,message=FALSE}
sessionInfo()
```

